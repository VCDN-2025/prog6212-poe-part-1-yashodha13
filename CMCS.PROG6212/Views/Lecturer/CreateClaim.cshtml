@model CMCS.PROG6212.Models.Claim
@{
    ViewData["Title"] = "Create Claim";
}

@* Layout and styling are based on Bootstrap components and ASP.NET Core tag helpers (Bootstrap, 2024; Microsoft, 2024a). *@


@{
    ViewData["Title"] = "Create Claim";
}

<div class="container mt-4">
    <div class="card shadow-sm p-4">

        <h2 class="mb-3">Create Claim</h2>

        @* Messages from controller *@
        @if (TempData["Warn"] != null)
        {
            <div class="alert alert-warning">@TempData["Warn"]</div>
        }
        @if (TempData["Msg"] != null)
        {
            <div class="alert alert-success">@TempData["Msg"]</div>
        }

        @* Validation Summary *@
        @if (!ViewData.ModelState.IsValid)
        {
            <div class="alert alert-danger">
                <strong>⚠ Please fix the following errors:</strong>
                <ul class="mt-2 mb-0">
                    @foreach (var state in ViewData.ModelState)
                    {
                        foreach (var error in state.Value.Errors)
                        {
                            <li>@error.ErrorMessage</li>
                        }
                    }
                </ul>
            </div>
        }



        <form asp-controller="Lecturer"
              asp-action="CreateClaim"
              method="post"
              enctype="multipart/form-data"
              class="mt-3">

            @* Hidden lecturer id *@
            <input asp-for="LecturerId" type="hidden" />

            @* NEW: Lecturer Name visible for clarity *@
            <div class="mb-3">
                <label class="form-label fw-bold">Lecturer</label>
                <input type="text" class="form-control" value="@Model.LecturerName" readonly />
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Month</label>
                <input asp-for="Month" type="month" class="form-control" required />
                <span asp-validation-for="Month" class="text-danger"></span>
            </div>

            <hr />

            <h4 class="mb-3">Claim Items</h4>

            <p class="text-muted">
                Enter the work done. Hours and rate must be greater than 0 (part of validation).
            </p>

            <table class="table align-middle" id="items-table">
                <thead class="table-light">
                    <tr>
                        <th>Description</th>
                        <th>Hours</th>
                        <th>Rate</th>
                        <th>Amount</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input name="ClaimItems[0].Description" class="form-control" placeholder="e.g. Marking, Invigilation" />
                        </td>
                        <td>
                            <input name="ClaimItems[0].HoursWorked" type="number" min="0" step="0.25" class="form-control hours" value="0" />
                        </td>
                        <td>
                            <input name="ClaimItems[0].Rate" type="number" min="0" step="1" class="form-control rate" value="0" />
                        </td>
                        <td class="amount">0.00</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-danger remove-row">Remove</button>
                        </td>
                    </tr>
                </tbody>
                <tfoot>
                    <tr>
                        <th colspan="3" class="text-end">Total Claim Amount:</th>
                        <th><span id="grand-total">0.00</span></th>
                        <th></th>
                    </tr>
                </tfoot>
            </table>

            <div class="d-flex gap-2 mb-4">
                <button type="button" id="add-row" class="btn btn-secondary">Add Item</button>
                <button type="button" id="clear-rows" class="btn btn-outline-secondary">Clear All Items</button>
            </div>

            <div class="mb-3">
                <label class="form-label fw-bold">Notes (optional)</label>
                <textarea asp-for="CoordinatorComments"
                          class="form-control"
                          rows="3"
                          placeholder="Any extra context (optional)"
                          data-val="false"></textarea>
            </div>


            <div class="mb-3">
                <label class="form-label fw-bold">Upload Supporting Documents</label>
                <div class="text-muted">Allowed: PDF, DOCX, XLSX</div>

                <input type="file" name="attachments" id="fileElem" multiple style="display:none;" />

                <div id="drop-area" class="border rounded p-3 text-center mt-2" style="min-height:120px; cursor:pointer;">
                    Drag & drop files here or click to select
                    <ul id="file-list" class="list-unstyled mt-2 mb-0"></ul>
                </div>
            </div>

            <div class="d-flex justify-content-end mt-4">
                <button type="submit" class="btn btn-primary btn-lg">Submit Claim</button>
            </div>

        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        let rowIndex = 1;

        function calcRowAmount($row) {
            const hours = parseFloat($row.find('.hours').val()) || 0;
            const rate = parseFloat($row.find('.rate').val()) || 0;
            const amount = (hours * rate).toFixed(2);
            $row.find('.amount').text(amount);
            return parseFloat(amount);
        }

        function updateAllTotals() {
            let sum = 0;
            $('#items-table tbody tr').each(function () {
                sum += calcRowAmount($(this));
            });
            document.getElementById('grand-total').textContent = sum.toFixed(2);
        }

        $(document).on('input', '.hours, .rate', updateAllTotals);

        $('#add-row').on('click', function () {
            const newRow = `
            <tr>
                <td><input name="ClaimItems[${rowIndex}].Description" class="form-control" placeholder="e.g. Tutorials" /></td>
                <td><input name="ClaimItems[${rowIndex}].HoursWorked" type="number" min="0" step="0.25" class="form-control hours" value="0" /></td>
                <td><input name="ClaimItems[${rowIndex}].Rate" type="number" min="0" step="1" class="form-control rate" value="0" /></td>
                <td class="amount">0.00</td>
                <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
            </tr>`;
            $('#items-table tbody').append(newRow);
            rowIndex++;
            updateAllTotals();
        });

        $(document).on('click', '.remove-row', function () {
            $(this).closest('tr').remove();
            updateAllTotals();
        });

        $('#clear-rows').on('click', function () {
            $('#items-table tbody').html(`
                <tr>
                    <td><input name="ClaimItems[0].Description" class="form-control" placeholder="e.g. Marking" /></td>
                    <td><input name="ClaimItems[0].HoursWorked" type="number" min="0" step="0.25" class="form-control hours" value="0" /></td>
                    <td><input name="ClaimItems[0].Rate" type="number" min="0" step="1" class="form-control rate" value="0" /></td>
                    <td class="amount">0.00</td>
                    <td><button type="button" class="btn btn-sm btn-danger remove-row">Remove</button></td>
                </tr>
            `);
            rowIndex = 1;
            updateAllTotals();
        });

        const dropArea = document.getElementById('drop-area');
        const fileInput = document.getElementById('fileElem');
        const fileList = document.getElementById('file-list');

        dropArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropArea.classList.add('bg-light');
        });
        dropArea.addEventListener('dragleave', () => dropArea.classList.remove('bg-light'));

        dropArea.addEventListener('drop', (e) => {
            e.preventDefault();
            dropArea.classList.remove('bg-light');
            fileInput.files = e.dataTransfer.files;
            renderFileList(fileInput.files);
        });

        dropArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', () => renderFileList(fileInput.files));

        function renderFileList(files) {
            fileList.innerHTML = '';
            Array.from(files || []).forEach(file => {
                const li = document.createElement('li');
                li.textContent = `${file.name} (${(file.size / 1024).toFixed(1)} KB)`;
                fileList.appendChild(li);
            });
        }

        updateAllTotals();
    </script>
}

@*
References (hidden on webpage using Razor comment)

[Insert your IIE Harvard Anglia references here if needed]
*@



@*
References

Microsoft Docs. 2025. Unit testing C# in .NET using dotnet test and xUnit. Microsoft Learn. 
Available at: https://learn.microsoft.com/en-us/dotnet/core/testing/unit-testing-csharp-with-xunit 
(Accessed: 22 October 2025).

xUnit.net. 2025. Getting Started with xUnit.net v2. xUnit.net. 
Available at: https://xunit.net/docs/getting-started/v2/getting-started 
(Accessed: 22 October 2025).

Chiarelli, A. 2021. Using xUnit to Test your C# Code. Auth0 Blog. 
Available at: https://auth0.com/blog/xunit-to-test-csharp-code 
(Accessed: 22 October 2025).

Spasojević, M. 2022. Unit Testing with xUnit in ASP.NET Core. Code Maze. 
Available at: https://code-maze.com/aspnetcore-unit-testing-xunit 
(Accessed: 22 October 2025).

Bruni, O. 2025. How to Use xUnit for Unit Testing in .NET Project Using C# in VSCode. 
Available at: https://www.ottorinobruni.com/how-to-use-xunit-for-unit-testing-in-dotnet-project-using-csharp-in-vscode 
(Accessed: 22 October 2025).
*@
